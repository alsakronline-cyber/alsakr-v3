# Production Docker Compose Configuration
# Optimized for VPS deployment with resource limits

services:
  # 1. AI Brain (Ollama)
  ollama:
    image: ollama/ollama:latest
    container_name: alsakr-ollama
    restart: always
    volumes:
      - ollama_data:/root/.ollama
    deploy:
      resources:
        limits:
          cpus: '2.00'
          memory: 6G
        reservations:
          memory: 2G
    networks:
      - industry-net
    healthcheck:
      test: [ "CMD", "ollama", "list" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # 2. Search Engine (Elasticsearch)
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: alsakr-es
    restart: always
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - cluster.name=alsakr-cluster
      - bootstrap.memory_lock=true
    volumes:
      - es_data:/usr/share/elasticsearch/data
    ulimits:
      memlock:
        soft: -1
        hard: -1
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    ports:
      - "9200:9200"
    networks:
      - industry-net
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5

  # 3. Vector Memory (Qdrant)
  qdrant:
    image: qdrant/qdrant:latest
    container_name: alsakr-qdrant
    restart: always
    volumes:
      - qdrant_data:/qdrant/storage
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    networks:
      - industry-net
    # Qdrant health check is disabled because the image lacks curl/wget
    # Health will be verified via backend connectivity
    # healthcheck:
    #   test: ["CMD-SHELL", "cat < /dev/null > /dev/tcp/127.0.0.1/6333 || exit 1"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 5

    # 4. CRM & Auth (PocketBase)
  pocketbase:
    image: ghcr.io/muchobien/pocketbase:latest
    container_name: alsakr-pb
    restart: always
    volumes:
      - pb_data:/pb/pb_data
    ports:
      - "8090:8090"
    deploy:
      resources:
        limits:
          memory: 500M
        reservations:
          memory: 256M
    networks:
      - industry-net
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8090/api/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # 5. Automation (n8n)
  n8n:
    image: n8nio/n8n:latest
    container_name: alsakr-n8n
    restart: always
    environment:
      - N8N_HOST=n8n.local
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - GENERIC_TIMEZONE=Africa/Cairo
    volumes:
      - n8n_data:/home/node/.n8n
    ports:
      - "5678:5678"
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    networks:
      - industry-net

  # 6. Frontend (Next.js)
  frontend:
    build:
      context: ../v2_project/frontend
      dockerfile: Dockerfile
      args:
        - NODE_ENV=production
        - NEXT_PUBLIC_API_URL=https://app.alsakronline.com
    container_name: alsakr-frontend
    restart: always
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-https://app.alsakronline.com}
      - NEXT_PUBLIC_PB_URL=${NEXT_PUBLIC_PB_URL:-https://app.alsakronline.com}
      - NEXTAUTH_URL=${NEXTAUTH_URL:-https://app.alsakronline.com}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
    ports:
      - "3000:3000"
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    networks:
      - industry-net
    depends_on:
      - backend
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000 || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # 7. Backend (FastAPI)
  backend:
    build:
      context: ../v2_project/backend
      dockerfile: Dockerfile
    container_name: alsakr-backend
    restart: always
    environment:
      - ES_HOST=elasticsearch
      - OLLAMA_HOST=http://ollama:11434
      - PB_URL=http://pocketbase:8090
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@alsakronline.com}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-password123}
      - QDRANT_HOST=qdrant
      - REDIS_HOST=redis
      - PYTHONUNBUFFERED=1
    depends_on:
      elasticsearch:
        condition: service_healthy
      qdrant:
        condition: service_started
      ollama:
        condition: service_healthy
    ports:
      - "8000:8000"
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    volumes:
      - ../v2_project/backend:/app
      - ../Data:/data
    networks:
      - industry-net
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8000/api/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # 8. Reverse Proxy & SSL (Caddy)
  caddy:
    image: caddy:latest
    container_name: alsakr-proxy
    restart: always
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp" # HTTP/3
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - industry-net
    depends_on:
      - frontend
      - backend
    healthcheck:
      test: [ "CMD-SHELL", "caddy version || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  ollama_data:
    driver: local
  es_data:
    driver: local
  qdrant_data:
    driver: local
  pb_data:
    driver: local
  n8n_data:
    driver: local
  caddy_data:
    driver: local
  caddy_config:
    driver: local

networks:
  industry-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
